import{bG as j,bH as T,a as p,bI as H,as as M,y as O,bJ as z,r as i,g as q,d as B,c as P,q as u,w as m,bK as U,j as e,b as N,bL as $}from"./index-DirEgLJ3.js";function F(s){return j({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"},child:[]},{tag:"path",attr:{d:"M13.73 21a2 2 0 0 1-3.46 0"},child:[]}]})(s)}function G(s){return j({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"},child:[]},{tag:"polyline",attr:{points:"16 17 21 12 16 7"},child:[]},{tag:"line",attr:{x1:"21",y1:"12",x2:"9",y2:"12"},child:[]}]})(s)}const W=async()=>{try{await T(p,H),console.log("Session persistence set successfully")}catch(s){console.error("Error setting session persistence:",s)}},J=async()=>{try{const s=sessionStorage.getItem("currentTabId");return await M(p),sessionStorage.removeItem("currentTabId"),console.log("Logged out successfully"),{success:!0}}catch(s){return console.error("Logout error:",s),{success:!1,error:s}}},K=()=>{if(!sessionStorage.getItem("currentTabId")){const s=`tab_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;sessionStorage.setItem("currentTabId",s),console.log(`Created new tab ID: ${s}`)}return sessionStorage.getItem("currentTabId")},V=({title:s})=>{const v=O(),I=z(),[r,g]=i.useState(null),[b,h]=i.useState([]),[y,x]=i.useState(0),[S,L]=i.useState(!1),[k,w]=i.useState(!1),C=()=>!(I.pathname.includes("academic-dashboard")&&s==="Academic Admin Dashboard");i.useEffect(()=>{K(),W();const t=p.onAuthStateChanged(async a=>{if(!a){g(null);return}const c=a.uid,f=[["users","researcher"],["admins","admin"],["academicAdmins","academic_admin"],["departmentAdmins","department_admin"]];for(const[d,l]of f){const o=await q(B(N,d,c));if(o.exists()){g({uid:c,role:l,...o.data()});return}}g({uid:c,role:"unknown"})});return()=>t()},[]),i.useEffect(()=>{if(!r){h([]),x(0);return}const t=P(N,"notifications");let a;if(r.role==="researcher")a=u(t,m("recipientId","==",r.uid));else if(r.role==="admin")a=u(t,m("type","in",["manual","system"]));else if(r.role==="department_admin")a=u(t,m("departmentId","==",r.department));else if(r.role==="academic_admin")a=u(t,m("type","==","manual"));else return;let c=!0;const f=U(a,d=>{if(c){h(d.docs.map(o=>({id:o.id,...o.data()}))),c=!1;return}const l=d.docChanges().filter(o=>o.type==="added");if(l.length){const o=l.map(n=>({id:n.doc.id,...n.doc.data()}));h(n=>[...o,...n]),x(n=>n+l.length),l.forEach(n=>{const{title:D,message:E}=n.doc.data();$.info({message:D,description:E})})}},d=>console.error("Notifications listener error:",d));return()=>f()},[r]);const _=()=>{L(t=>(t||x(0),!t))},A=async()=>{w(!0);const t=await J();w(!1),t.success?v("/"):console.error("Logout failed:",t.error)};return C()?e.jsx("header",{className:"bg-white shadow-lg border-b border-gray-300",children:e.jsxs("div",{className:"max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:s}),r&&e.jsxs("div",{className:"flex items-center space-x-4 relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx(F,{size:24,className:"text-gray-900 cursor-pointer hover:text-blue-500",onClick:_}),y>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center",children:y}),S&&e.jsxs("div",{className:"absolute right-0 mt-3 w-80 bg-white rounded-lg shadow-xl z-50 border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-4 py-2 border-b border-gray-200 bg-gray-50",children:e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Notifications"})}),b.length>0?e.jsx("div",{className:"max-h-60 overflow-y-auto",children:b.map(t=>{var a;return e.jsxs("div",{className:"px-4 py-2 hover:bg-gray-50 border-b border-gray-100",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800",children:t.title}),e.jsx("p",{className:"text-xs text-gray-500",children:t.message}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:(a=t.timestamp)==null?void 0:a.toDate().toLocaleString()})]},t.id)})}):e.jsx("div",{className:"px-4 py-4 text-sm text-gray-500 text-center",children:"No notifications"})]})]}),r.role==="department_admin"&&e.jsx("div",{className:"bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium",children:r.department.replace("dept_","").toUpperCase()}),e.jsx("button",{onClick:A,disabled:k,className:"flex items-center text-gray-900 cursor-pointer hover:text-red-500 disabled:opacity-50",children:e.jsx(G,{size:24})})]})]})}):null};export{V as H};
